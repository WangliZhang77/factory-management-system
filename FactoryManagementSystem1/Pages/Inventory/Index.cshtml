using FactoryManagementSystem1.Data;
using FactoryManagementSystem1.Domain.Entities;
using FactoryManagementSystem1.Domain.Enums;
using Microsoft.AspNetCore.Mvc.RazorPages;
using Microsoft.EntityFrameworkCore;

namespace FactoryManagementSystem1.Pages
{
    public class IndexModel : PageModel
    {
        private readonly ApplicationDbContext _db;

        public IndexModel(ApplicationDbContext db)
        {
            _db = db;
        }

        // Statistics
        public int TotalInventoryItems { get; set; }
        public int LowStockCount { get; set; }
        public int TotalWorkOrders { get; set; }
        public int DraftWorkOrders { get; set; }
        public int SubmittedWorkOrders { get; set; }
        public int ApprovedWorkOrders { get; set; }
        public int InProgressWorkOrders { get; set; }
        public int CompletedWorkOrders { get; set; }

        // Recent Activity
        public List<AuditLog>
    RecentAuditLogs { get; set; } = new();

    public async Task OnGetAsync()
    {
    // Inventory Statistics
    TotalInventoryItems = await _db.InventoryItems
    .Where(i => i.IsActive)
    .CountAsync();

    LowStockCount = await _db.InventoryItems
    .Where(i => i.IsActive && i.OnHandQty <= i.LowStockThreshold)
    .CountAsync();

    // Work Order Statistics
    TotalWorkOrders = await _db.WorkOrders.CountAsync();
    DraftWorkOrders = await _db.WorkOrders
    .CountAsync(w => w.Status == WorkOrderStatus.Draft);
    SubmittedWorkOrders = await _db.WorkOrders
    .CountAsync(w => w.Status == WorkOrderStatus.Submitted);
    ApprovedWorkOrders = await _db.WorkOrders
    .CountAsync(w => w.Status == WorkOrderStatus.Approved);
    InProgressWorkOrders = await _db.WorkOrders
    .CountAsync(w => w.Status == WorkOrderStatus.InProgress);
    CompletedWorkOrders = await _db.WorkOrders
    .CountAsync(w => w.Status == WorkOrderStatus.Completed);

    // Recent Audit Logs (last 10)
    RecentAuditLogs = await _db.AuditLogs
    .OrderByDescending(a => a.TimestampUtc)
    .Take(10)
    .ToListAsync();
    }
    }
    }
